# Maintainer: local

pkgname=tiss-greetd-qml
pkgver=0.1.0.r0.g0000000
pkgrel=1
pkgdesc="QML-based greetd greeter (tiss-greetd)"
arch=(x86_64)
license=(custom)
depends=(qt6-base qt6-declarative greetd cage libseat)
makedepends=(cmake rust cargo git)
optdepends=(
  "seatd: seat management backend if not using logind"
)
install=tiss-greetd-qml.install

# Update this URL to your repo.
_repo_url="git@github.com:everyoneexe/ingress.git"
source=("${pkgname}::git+${_repo_url}")
sha256sums=('SKIP')

pkgver() {
  cd "${srcdir}/${pkgname}"
  local tag
  tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
  if [[ -n "${tag}" ]]; then
    printf "%s.r%s.g%s" \
      "${tag#v}" \
      "$(git rev-list --count HEAD)" \
      "$(git rev-parse --short HEAD)"
  else
    printf "0.1.0.r%s.g%s" \
      "$(git rev-list --count HEAD)" \
      "$(git rev-parse --short HEAD)"
  fi
}

build() {
  local root="${srcdir}/${pkgname}"

  cd "${root}/backend"
  CARGO_TARGET_DIR="${srcdir}/target" cargo build --release

  cd "${root}/launcher"
  CARGO_TARGET_DIR="${srcdir}/target" cargo build --release

  cmake -S "${root}/ui" -B "${srcdir}/build-ui" -DCMAKE_BUILD_TYPE=Release
  cmake --build "${srcdir}/build-ui"
}

package() {
  local root="${srcdir}/${pkgname}"

  install -Dm755 "${srcdir}/target/release/tiss-greetd-backend" "${pkgdir}/usr/lib/tiss-greetd/tiss-greetd-backend"
  install -Dm755 "${srcdir}/build-ui/tiss-greetd-ui" "${pkgdir}/usr/bin/tiss-greetd-ui"
  install -Dm755 "${srcdir}/target/release/tiss-greetd-launcher" "${pkgdir}/usr/bin/tiss-greetd-launcher"
  install -Dm755 "${srcdir}/target/release/tiss-greetd-appearance" "${pkgdir}/usr/bin/tiss-greetd-appearance"

  install -Dm644 "${root}/ui/qml/Main.qml" "${pkgdir}/usr/share/tiss-greetd/qml/Main.qml"
  install -Dm644 "${root}/docs/greetd-config.toml.example" "${pkgdir}/usr/share/tiss-greetd/greetd-config.toml.example"
  install -Dm644 "${root}/docs/tiss-greetd-config.toml.example" "${pkgdir}/usr/share/tiss-greetd/config.toml.example"

  install -Dm644 "${root}/README.md" "${pkgdir}/usr/share/doc/tiss-greetd-qml/README.md"
  install -Dm644 "${root}/docs/run.md" "${pkgdir}/usr/share/doc/tiss-greetd-qml/run.md"
}
